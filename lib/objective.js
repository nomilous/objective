// Generated by CoffeeScript 1.9.2
var Objective, TODO, debug, deferred, error, fs, info, path, pipe, pipeline, program, ref, ref1, required, util, uuid;

ref = require('also'), deferred = ref.deferred, pipeline = ref.pipeline, util = ref.util;

if (process.env.DEBUG == null) {
  process.env.DEBUG = 'info,error,TODO';
}

ref1 = require('./logger'), info = ref1.info, debug = ref1.debug, error = ref1.error, TODO = ref1.TODO;

pipe = require('./globals/pipeline');

pipe.createEvent('objective.result');

pipe.createEvent('objective.notify');

path = require('path');

fs = require('fs');

uuid = require('uuid');

required = {};

module.exports = Objective = function(config) {
  var base, count, loadGlobal, moduleName, oldConfig, run, title;
  if (config == null) {
    config = {};
  }
  if (typeof config === 'string') {
    title = config;
    config = arguments[1] || {};
    config.title = title;
  }
  if (objective.root != null) {
    (base = objective.root).children || (base.children = {});
    if (objective.root.children[config.uuid] != null) {
      oldConfig = objective.root.children[config.uuid].root;
      objective.prompt.startbg();
      info("Updating '" + config.title + "' from '" + oldConfig.filename + "'");
      config.filename = oldConfig.filename;
      objective.root.children[config.uuid] = {
        root: config
      };
      objective.root.children[config.uuid].doRun = true;
    } else {
      config.filename = objective.loading;
      info("Loading '" + config.title + "' from '" + config.filename + "'");
      objective.root.children[config.uuid] = {
        root: config
      };
    }
    return {
      run: function(fn) {
        var e, moduleFile, name, running;
        objective.root.children[config.uuid].run = fn;
        if (program.run || objective.root.children[config.uuid].doRun) {
          for (moduleFile in require.cache) {
            if (required[moduleFile]) {
              continue;
            }
            delete require.cache[moduleFile];
          }
          info("Running '" + config.title + "' from '" + config.filename + "'");
          try {
            for (name in objective.plugins) {
              try {
                objective.plugins[name].before(config);
              } catch (_error) {}
            }
            running = fn();
            if ((running != null) && typeof running.then === 'function') {
              running.then(function(result) {
                debug({
                  result: result
                });
                return pipe.emit('objective.result', {
                  error: null,
                  result: result
                }, function() {
                  return objective.prompt.endbg();
                });
              }, function(error) {
                error({
                  error: error
                });
                return pipe.emit('objective.result', {
                  error: error,
                  result: null
                }, function() {
                  return objective.prompt.endbg();
                });
              }, function(message) {
                debug({
                  notify: notify
                });
                return pipe.emit('objective.notify', {
                  message: message
                }, function() {});
              });
              if (typeof running.start === 'function') {
                return running.start();
              }
            } else {
              return objective.prompt.endbg();
            }
          } catch (_error) {
            e = _error;
            return error(e.stack + '\n');
          }
        }
      }
    };
  }
  objective.root = config;
  run = function(e) {
    console.log('Missing .run(fn)');
    if (e != null) {
      return console.log(e.toString());
    }
  };
  loadGlobal = function(name, path) {
    if (objective[name] != null) {
      info("Warning: global " + name + " not loaded.");
      return;
    }
    objective[name] = require(path);
    if (name === 'coffee') {
      return objective.coffee.register();
    }
  };
  loadGlobal('recurse', './globals/recurse');
  loadGlobal('coffee', 'coffee-script');
  loadGlobal('uplink', './globals/uplink');
  loadGlobal('prompt', './globals/prompt');
  loadGlobal('pipe', './globals/pipeline');
  config.plugins || (config.plugins = []);
  objective.plugins || (objective.plugins = {});
  count = 1;
  pipeline((function() {
    var j, len, ref2, results;
    ref2 = config.plugins;
    results = [];
    for (j = 0, len = ref2.length; j < len; j++) {
      moduleName = ref2[j];
      results.push((function(moduleName) {
        return deferred(function(arg1) {
          var camel, e, i, k, name, p, parts, ref3, reject, resolve;
          resolve = arg1.resolve, reject = arg1.reject;
          if (typeof moduleName !== 'string') {
            if (!moduleName.name) {
              moduleName.name = "plugin" + (count++);
              info("Warning: Plugin without name. (set .name property)");
            }
            if (global[moduleName.name] != null) {
              return reject(new Error("Plugin " + moduleName + " collides with global." + moduleName.name));
            }
            info("Loading plugin '" + moduleName + "' as '" + moduleName.name + "'");
            global[moduleName.name] = moduleName;
            try {
              moduleName.init(function(e) {
                if (e != null) {
                  return reject(e);
                }
                return resolve();
              });
            } catch (_error) {
              e = _error;
              return reject(e);
            }
            return;
          }
          name = moduleName.split(path.sep).pop().replace(/objective-/, '');
          if (name.match(/[-\._]/)) {
            parts = name.split(/[-\._]/);
            camel = parts[0];
            for (i = k = 1, ref3 = parts.length - 1; 1 <= ref3 ? k <= ref3 : k >= ref3; i = 1 <= ref3 ? ++k : --k) {
              p = parts[i][0].toUpperCase();
              camel += p + parts[i].slice(1);
            }
            name = camel;
          }
          if (global[name] != null) {
            return reject(new Error("Plugin " + moduleName + " collides with global." + name));
          }
          try {
            if (moduleName.match(/^\./)) {
              moduleName = path.normalize(process.cwd() + path.sep + moduleName);
            }
            global[name] = require(moduleName);
          } catch (_error) {
            e = _error;
            return reject(e);
          }
          info("Loading plugin '" + moduleName + "' as '" + name + "'");
          try {
            return global[name].init(function(e) {
              if (e != null) {
                return reject(e);
              }
              objective.plugins[name] = global[name];
              return resolve();
            });
          } catch (_error) {
            e = _error;
            return reject(e);
          }
        });
      })(moduleName));
    }
    return results;
  })()).then(function(result) {
    TODO('promises after run to emit');
    return process.nextTick(function() {
      var dir, filename;
      for (filename in require.cache) {
        required[filename] = {};
      }
      if (program.recurse != null) {
        if (typeof program.recurse !== 'string') {
          info("\nRecurse needs [dir]");
          return;
        }
        dir = program.recurse;
        return objective.recurse(dir, function(err) {
          if (err != null) {
            return run(err);
          }
          return run(null);
        });
      }
      if (program.prompt) {
        return objective.prompt();
      }
      return run(null);
    });
  }, function(err) {
    TODO('promises after run to emit');
    if (program.prompt) {
      return error(err.stack);
    }
    return process.nextTick(function() {
      var arg, argsToRun, i, j, k, len, position, ref2, runArgs;
      runArgs = util.argsOf(run);
      i = 0;
      position = -1;
      for (j = 0, len = runArgs.length; j < len; j++) {
        arg = runArgs[j];
        if (arg === 'e' || arg === 'er' || arg === 'err' || arg === 'error') {
          position = i;
        }
        i++;
      }
      if (position >= 0) {
        argsToRun = [];
        for (i = k = 0, ref2 = runArgs.length - 1; 0 <= ref2 ? k <= ref2 : k >= ref2; i = 0 <= ref2 ? ++k : --k) {
          if (i === position) {
            argsToRun.push(err);
          } else {
            argsToRun.push(i);
          }
        }
        return run.apply({}, argsToRun);
      }
      error(err.stack);
      return run.apply({});
    });
  });
  return {
    run: function(fn) {
      return run = fn;
    }
  };
};

Object.defineProperty(global, 'objective', {
  get: function() {
    return Objective;
  },
  configurable: false
});

program = require('./cli');

objective.logger = require('./logger');

program.start();
