// Generated by CoffeeScript 1.9.2
var Pipeline, debug, deferred, pipeline, ref;

ref = require('also'), pipeline = ref.pipeline, deferred = ref.deferred;

debug = require('../logger').debug;

module.exports = Pipeline = {
  pipes: {},
  createEvent: function(event) {
    var base;
    debug("pipeline created event '" + event + "'");
    return (base = Pipeline.pipes)[event] || (base[event] = []);
  },
  emit: function(event, payload, callback) {
    var fn, pipe;
    if (!(pipe = Pipeline.pipes[event])) {
      return callback(new Error("No handlers for '" + event + "'."));
    }
    debug("pipeline emitted event '" + event + "'");
    return pipeline((function() {
      var i, len, results;
      results = [];
      for (i = 0, len = pipe.length; i < len; i++) {
        fn = pipe[i];
        results.push((function(fn) {
          return deferred(function(action) {
            debug("pipeline event handler running event '" + event + "'");
            return fn(payload, action.resolve);
          });
        })(fn));
      }
      return results;
    })()).then(function(result) {
      debug("pipeline event '" + event + "' done ok");
      return callback(null, payload);
    }, function(error) {
      debug("pipeline event '" + event + "' failed " + (error.toString()));
      return callback(error);
    }, function(notify) {});
  },
  on: function(event, fn) {
    var base;
    debug("pipeline registering handler on event '" + event + "'");
    (base = Pipeline.pipes)[event] || (base[event] = []);
    return Pipeline.pipes[event].push(fn);
  }
};
